{% extends "logbook/base.html" %}
{% load logbook_extras %}
{% block content %}
  <header style="margin-bottom:1rem; display:flex; align-items:center; justify-content:space-between;">
    {% if object %}
      <h2 style="margin:0">Edit Log Entry</h2>
    {% else %}
      <h2 style="margin:0">New Log Entry</h2>
    {% endif %}
    <a class="btn" href="{% url 'logbook:list' %}">Back to Logbook</a>
  </header>

  <style>
    .grid-2 { display:grid; grid-template-columns: 1fr; gap: 12px 24px; }
    @media (min-width: 768px) { .grid-2 { grid-template-columns: 1fr 1fr; } }
    /* Fluid grid with comfortable min width so fields aren't cramped */
    .grid-fluid { display:grid; grid-template-columns: repeat(auto-fit, minmax(480px, 1fr)); gap: 12px 24px; }
    .form-section { border: 1px solid #e5e7eb; border-radius: 10px; padding: 16px; margin-bottom: 16px; background: #fff; width: 100%; display: block; }
    .form-section h3 { margin: 0 0 8px 0; font-size: 1rem; color: #111827; }
    .field { margin: 0; }
    .hint { color:#6b7280; font-size: .85em; }
    .optional-field { display: none; }
    .optional-field.visible { display: block; }
    .inline-actions { display:flex; align-items:center; gap:8px; }
    .btn-ghost { border-color:#d1d5db; color:#374151; background:#fff; }
    .toggle-list { display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; margin-top: 8px; }
    .toggle-btn { display:inline-flex; align-items:center; justify-content:center; padding: 6px 10px; border:1px solid #d1d5db; border-radius: 8px; background:#fff; color:#374151; cursor:pointer; user-select:none; }
    .toggle-btn[aria-pressed="true"] { background:#065f46; color:#fff; border-color:#065f46; }
    .toggle-toolbar { display:flex; gap:8px; align-items:end; justify-content:space-between; flex-wrap:wrap; }
    .srch { width:100%; max-width:460px; }
  </style>

  <form method="post" novalidate>
    {% csrf_token %}

    {# Baseline fields (always shown) #}
    <div class="grid-fluid" id="main-grid">
      <div class="field" id="field-callsign">
        <label>{{ form.callsign.label_tag }}</label>
        {{ form.callsign }}
        {% if form.callsign.help_text %}<small>{{ form.callsign.help_text }}</small>{% endif %}
        {% for error in form.callsign.errors %}<div style="color:#a00">{{ error }}</div>{% endfor %}
      </div>
      <div class="field" id="field-qso_date">
        <label>{{ form.qso_date.label_tag }}</label>
        {{ form.qso_date }}
        {% if form.qso_date.help_text %}<small>{{ form.qso_date.help_text }}</small>{% endif %}
        {% for error in form.qso_date.errors %}<div style="color:#a00">{{ error }}</div>{% endfor %}
      </div>
      <div class="field" id="field-time_on">
        <label>{{ form.time_on.label_tag }}</label>
        {{ form.time_on }}
        {% if form.time_on.help_text %}<small>{{ form.time_on.help_text }}</small>{% endif %}
        {% for error in form.time_on.errors %}<div style="color:#a00">{{ error }}</div>{% endfor %}
      </div>
      <div class="field" id="field-band">
        <label>{{ form.band.label_tag }}</label>
        {{ form.band }}
        {% if form.band.help_text %}<small>{{ form.band.help_text }}</small>{% endif %}
        {% for error in form.band.errors %}<div style="color:#a00">{{ error }}</div>{% endfor %}
      </div>
      <div class="field" id="field-mode">
        <label>{{ form.mode.label_tag }}</label>
        {{ form.mode }}
        {% if form.mode.help_text %}<small>{{ form.mode.help_text }}</small>{% endif %}
        {% for error in form.mode.errors %}<div style="color:#a00">{{ error }}</div>{% endfor %}
      </div>
      <div class="field" id="field-rst_sent">
        <label>{{ form.rst_sent.label_tag }}</label>
        {{ form.rst_sent }}
        {% if form.rst_sent.help_text %}<small>{{ form.rst_sent.help_text }}</small>{% endif %}
        {% for error in form.rst_sent.errors %}<div style="color:#a00">{{ error }}</div>{% endfor %}
      </div>
      <div class="field" id="field-rst_rcvd">
        <label>{{ form.rst_rcvd.label_tag }}</label>
        {{ form.rst_rcvd }}
        {% if form.rst_rcvd.help_text %}<small>{{ form.rst_rcvd.help_text }}</small>{% endif %}
        {% for error in form.rst_rcvd.errors %}<div style="color:#a00">{{ error }}</div>{% endfor %}
      </div>
      {% comment %} Render additional model fields inline; hidden unless value {% endcomment %}
      {% for f in optional_fields %}
        {% with field=form|attr:f.name %}
          {% if field %}
          <div class="field optional-field{% if f.checked %} visible{% endif %}" id="field-{{f.name}}-opt" data-name="{{f.name}}">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:4px;">
              <label style="margin:0;">{{ field.label_tag }}</label>
              <button type="button" class="btn btn-ghost" data-remove-opt="{{f.name}}" title="Hide field">Hide</button>
            </div>
            {{ field }}
            {% if field.help_text %}<small class="hint">{{ field.help_text }}</small>{% endif %}
            {% for error in field.errors %}<div style="color:#a00">{{ error }}</div>{% endfor %}
          </div>
          {% endif %}
        {% endwith %}
      {% endfor %}
      {% comment %} Render ALL extras from catalog; visible only if value exists or checked {% endcomment %}
      {% for ex in extras_catalog %}
        {% with tag=ex.tag label=ex.label %}
        {% with val=extras_values|dict_get:tag %}
        <div class="field optional-field{% if val %} visible{% elif ex.checked %} visible{% endif %}" id="extra-{{ tag|lower }}-opt" data-extra="{{ tag }}">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:4px;">
            <label style="margin:0;">{{ label }}</label>
            <button type="button" class="btn btn-ghost" data-hide-extra="{{ tag }}" title="Hide field">Hide</button>
          </div>
          <input type="hidden" name="extra_key" value="{{ tag }}" />
          <input name="extra_val" value="{{ val }}" />
        </div>
        {% endwith %}
        {% endwith %}
      {% endfor %}
    </div>

    

    <div class="form-section">
      <div style="display:flex; align-items:end; justify-content:space-between; gap:16px; margin-bottom:8px;">
        <h3 style="margin:0;">Additional Fields</h3>
        <label style="display:flex; align-items:center; gap:8px;">
          <span>Operation Profile</span>
          <select id="profile-select">
            <option value="default">Default</option>
            <option value="pota">POTA</option>
            <option value="sota">SOTA</option>
            <option value="satellite">Satellite</option>
            <option value="vhfuhf">VHF/UHF Local</option>
          </select>
        </label>
      </div>
      <div class="form-section" style="padding:12px; margin: 0 0 12px 0; background:#f9fafb; border:1px dashed #d1d5db;">
        <div class="toggle-toolbar">
          <div style="flex:1; min-width:260px;">
            <input id="toggle-search" class="srch" placeholder="Search additional fields (label or name)" />
            <div class="hint">Toggle fields on/off. Search narrows the list.</div>
          </div>
          <div class="inline-actions">
            <button type="button" class="btn btn-ghost" id="toggle-all-on">Show All</button>
            <button type="button" class="btn btn-ghost" id="toggle-all-off">Hide All</button>
          </div>
        </div>
        <div id="toggle-list" class="toggle-list" aria-label="Additional fields toggles"></div>
      </div>
      {# Extras add UI removed: all model fields are pre-rendered and toggleable #}
    </div>

    

    <div class="actions" style="display:flex; gap:8px; justify-content:flex-end; margin-top: 16px;">
      <a class="btn btn-ghost" href="{% url 'logbook:list' %}">Cancel</a>
      <button class="btn" type="submit">Save Entry</button>
    </div>
  </form>

  <script>
    // Catalog of optional fields from server
    const OPTIONAL_CATALOG = [
      {% for f in optional_fields %}{ name: "{{ f.name }}", label: "{{ f.label }}", checked: {{ f.checked|yesno:"true,false" }} }{% if not forloop.last %},{% endif %}{% endfor %}
    ];
    const EXTRAS_CATALOG = [
      {% for ex in extras_catalog %}{ tag: "{{ ex.tag }}", label: "{{ ex.label }}", checked: {{ ex.checked|yesno:"true,false" }} }{% if not forloop.last %},{% endif %}{% endfor %}
    ];

    // Lightweight, UI-only operation profiles
    const PROFILES = {
      default: [],
      pota: ["sig", "sig_info", "my_sig", "my_sig_info"],
      sota: ["sota_ref", "my_sota_ref", "sig", "sig_info", "my_sig", "my_sig_info"],
      satellite: ["prop_mode", "sat_name", "band_rx", "freq_rx", "submode"],
      vhfuhf: ["gridsquare", "my_gridsquare", "my_vucc_grids", "tx_pwr"],
    };

    function showOptionalFieldByName(name) {
      const block = document.getElementById('field-' + name + '-opt');
      if (!block) return false;
      block.classList.add('visible');
      const input = block.querySelector('input, select, textarea');
      if (input) input.focus();
      return true;
    }

    function clearAndHideOptionalField(name) {
      const block = document.getElementById('field-' + name + '-opt');
      if (!block) return;
      block.querySelectorAll('input, select, textarea').forEach(el => {
        if (el.tagName === 'INPUT' && el.type === 'hidden') return; // don't clear hidden keys
        if (el.tagName === 'SELECT') {
          el.selectedIndex = 0;
        } else {
          el.value = '';
        }
      });
      block.classList.remove('visible');
    }

    function hideOptionalField(name) {
      const block = document.getElementById('field-' + name + '-opt');
      if (!block) return;
      block.classList.remove('visible');
    }

    function fieldHasValue(name) {
      const block = document.getElementById('field-' + name + '-opt');
      if (!block) return false;
      const input = block.querySelector('input, select, textarea');
      if (!input) return false;
      if (input.tagName === 'SELECT') return input.value !== '' && input.selectedIndex > 0;
      return (input.value || '').trim() !== '';
    }

    // Extras helpers
    function showExtraByTag(tag) {
      const block = document.getElementById('extra-' + tag.toLowerCase() + '-opt');
      if (!block) return false;
      block.classList.add('visible');
      const input = block.querySelector('input[name="extra_val"]');
      if (input) input.focus();
      return true;
    }
    function clearAndHideExtra(tag) {
      const block = document.getElementById('extra-' + tag.toLowerCase() + '-opt');
      if (!block) return;
      const val = block.querySelector('input[name="extra_val"]');
      if (val) val.value = '';
      block.classList.remove('visible');
    }
    function extraHasValue(tag) {
      const block = document.getElementById('extra-' + tag.toLowerCase() + '-opt');
      if (!block) return false;
      const val = block.querySelector('input[name="extra_val"]');
      return !!(val && (val.value || '').trim() !== '');
    }

    function applyProfile(key) {
      const wanted = new Set(PROFILES[key] || []);
      OPTIONAL_CATALOG.forEach(it => {
        const { name } = it;
        if (wanted.has(name)) {
          showOptionalFieldByName(name);
          const btn = document.querySelector('#toggle-list .toggle-btn[data-type="opt"][data-key="' + name + '"]');
          if (btn) btn.setAttribute('aria-pressed', 'true');
        } else {
          // Hide only if no current value to avoid surprising the user
          if (!fieldHasValue(name)) {
            hideOptionalField(name);
            const btn = document.querySelector('#toggle-list .toggle-btn[data-type="opt"][data-key="' + name + '"]');
            if (btn) btn.setAttribute('aria-pressed', 'false');
          }
        }
      });
      try { localStorage.setItem('loghub.profile', key); } catch (e) {}
    }

    // Build toggle buttons UI
    (function buildToggles() {
      const list = document.getElementById('toggle-list');
      if (!list) return;
      const frag = document.createDocumentFragment();
      const makeBtn = (key, label, checked, type) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'toggle-btn';
        btn.setAttribute('data-type', type);
        btn.setAttribute('data-key', key);
        btn.setAttribute('aria-pressed', checked ? 'true' : 'false');
        btn.textContent = label;
        btn.addEventListener('click', () => {
          const active = btn.getAttribute('aria-pressed') === 'true';
          if (active) {
            if (type === 'opt') clearAndHideOptionalField(key); else clearAndHideExtra(key);
            btn.setAttribute('aria-pressed', 'false');
          } else {
            if (type === 'opt') showOptionalFieldByName(key); else showExtraByTag(key);
            btn.setAttribute('aria-pressed', 'true');
          }
        });
        return btn;
      };
      OPTIONAL_CATALOG.forEach(it => frag.appendChild(makeBtn(it.name, it.label, !!it.checked, 'opt')));
      EXTRAS_CATALOG.forEach(it => frag.appendChild(makeBtn(it.tag, it.label, !!it.checked, 'extra')));
      list.appendChild(frag);
    })();

    // Keep toggle state in sync with visible fields
    function syncToggleStates() {
      document.querySelectorAll('#toggle-list .toggle-btn').forEach(btn => {
        const key = btn.getAttribute('data-key');
        const type = btn.getAttribute('data-type');
        if (!key || !type) return;
        let active = false;
        if (type === 'opt') {
          const block = document.getElementById('field-' + key + '-opt');
          active = !!(block && block.classList.contains('visible'));
        } else {
          const block = document.getElementById('extra-' + key.toLowerCase() + '-opt');
          active = !!(block && block.classList.contains('visible'));
        }
        btn.setAttribute('aria-pressed', active ? 'true' : 'false');
      });
    }

    // Toggle search filter
    (function wireSearch() {
      const inp = document.getElementById('toggle-search');
      const list = document.getElementById('toggle-list');
      if (!inp || !list) return;
      function applyFilter() {
        const q = (inp.value || '').trim().toLowerCase();
        list.querySelectorAll('.toggle-btn').forEach(btn => {
          const key = btn.getAttribute('data-key') || '';
          const label = btn.textContent || '';
          const hit = !q || key.toLowerCase().includes(q) || label.toLowerCase().includes(q);
          btn.style.display = hit ? '' : 'none';
        });
      }
      inp.addEventListener('input', applyFilter);
      applyFilter();
    })();

    // Show/Hide all helpers
    document.getElementById('toggle-all-on').addEventListener('click', () => {
      document.querySelectorAll('#toggle-list .toggle-btn').forEach(btn => {
        const key = btn.getAttribute('data-key');
        const type = btn.getAttribute('data-type');
        if (!key || !type) return;
        if (type === 'opt') showOptionalFieldByName(key); else showExtraByTag(key);
        btn.setAttribute('aria-pressed', 'true');
      });
    });
    document.getElementById('toggle-all-off').addEventListener('click', () => {
      document.querySelectorAll('#toggle-list .toggle-btn').forEach(btn => {
        const key = btn.getAttribute('data-key');
        const type = btn.getAttribute('data-type');
        if (!key || !type) return;
        if (type === 'opt') clearAndHideOptionalField(key); else clearAndHideExtra(key);
        btn.setAttribute('aria-pressed', 'false');
      });
    });

    // No extras add UI: all model fields are pre-rendered and toggleable

    // Hide buttons for optional/extras fields
    document.addEventListener('click', (e) => {
      const t = e.target;
      if (t && t.matches('button[data-remove-opt], button[data-hide-opt]')) {
        const name = t.getAttribute('data-remove-opt') || t.getAttribute('data-hide-opt');
        clearAndHideOptionalField(name);
      }
      if (t && t.matches('button[data-remove-extra], button[data-hide-extra]')) {
        const tag = t.getAttribute('data-remove-extra') || t.getAttribute('data-hide-extra');
        clearAndHideExtra(tag);
      }
    });

    // Toggle UI controls visibility of additional fields; extras managed above

    // Profile init and change handler
    (function initProfile() {
      const sel = document.getElementById('profile-select');
      if (!sel) return;
      try {
        const saved = localStorage.getItem('loghub.profile');
        if (saved && PROFILES[saved]) {
          sel.value = saved;
          applyProfile(saved);
          syncToggleStates();
        }
      } catch (e) {}
      sel.addEventListener('change', () => { applyProfile(sel.value); syncToggleStates(); });
      syncToggleStates();
    })();
  </script>
{% endblock %}
