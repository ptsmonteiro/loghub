{% extends "logbook/base.html" %}
{% load logbook_extras %}
{% block content %}
  <header style="margin-bottom:1rem; display:flex; align-items:center; justify-content:space-between;">
    {% if object %}
      <h2 style="margin:0">Edit Log Entry</h2>
    {% else %}
      <h2 style="margin:0">New Log Entry</h2>
    {% endif %}
    <a class="btn" href="{% url 'logbook:list' %}">Back to Logbook</a>
  </header>

  <style>
    .grid-2 { display:grid; grid-template-columns: 1fr; gap: 12px 24px; }
    @media (min-width: 768px) { .grid-2 { grid-template-columns: 1fr 1fr; } }
    /* Fluid grid with comfortable min width so fields aren't cramped */
    .grid-fluid { display:grid; grid-template-columns: repeat(auto-fit, minmax(480px, 1fr)); gap: 12px 24px; }
    .form-section { border: 1px solid #e5e7eb; border-radius: 10px; padding: 16px; margin-bottom: 16px; background: #fff; width: 100%; display: block; }
    .form-section h3 { margin: 0 0 8px 0; font-size: 1rem; color: #111827; }
    .field { margin: 0; }
    .hint { color:#6b7280; font-size: .85em; }
    .optional-picker { border: 1px dashed #d1d5db; padding: 12px; border-radius: 8px; background:#f9fafb; }
    .optional-fields { margin-top: 12px; }
    .optional-field { display: none; }
    .optional-field.visible { display: block; }
    .inline-actions { display:flex; align-items:center; gap:8px; }
    .btn-ghost { border-color:#d1d5db; color:#374151; background:#fff; }
  </style>

  <form method="post" novalidate>
    {% csrf_token %}

    {# Baseline fields (always shown) #}
    <div class="grid-fluid">
      <div class="field" id="field-callsign">
        <label>{{ form.callsign.label_tag }}</label>
        {{ form.callsign }}
        {% if form.callsign.help_text %}<small>{{ form.callsign.help_text }}</small>{% endif %}
        {% for error in form.callsign.errors %}<div style="color:#a00">{{ error }}</div>{% endfor %}
      </div>
      <div class="field" id="field-qso_date">
        <label>{{ form.qso_date.label_tag }}</label>
        {{ form.qso_date }}
        {% if form.qso_date.help_text %}<small>{{ form.qso_date.help_text }}</small>{% endif %}
        {% for error in form.qso_date.errors %}<div style="color:#a00">{{ error }}</div>{% endfor %}
      </div>
      <div class="field" id="field-time_on">
        <label>{{ form.time_on.label_tag }}</label>
        {{ form.time_on }}
        {% if form.time_on.help_text %}<small>{{ form.time_on.help_text }}</small>{% endif %}
        {% for error in form.time_on.errors %}<div style="color:#a00">{{ error }}</div>{% endfor %}
      </div>
      <div class="field" id="field-band">
        <label>{{ form.band.label_tag }}</label>
        {{ form.band }}
        {% if form.band.help_text %}<small>{{ form.band.help_text }}</small>{% endif %}
        {% for error in form.band.errors %}<div style="color:#a00">{{ error }}</div>{% endfor %}
      </div>
      <div class="field" id="field-mode">
        <label>{{ form.mode.label_tag }}</label>
        {{ form.mode }}
        {% if form.mode.help_text %}<small>{{ form.mode.help_text }}</small>{% endif %}
        {% for error in form.mode.errors %}<div style="color:#a00">{{ error }}</div>{% endfor %}
      </div>
    </div>

    

    <div class="form-section">
      <div style="display:flex; align-items:end; justify-content:space-between; gap:16px; margin-bottom:8px;">
        <h3 style="margin:0;">Additional Fields</h3>
        <label style="display:flex; align-items:center; gap:8px;">
          <span>Operation Profile</span>
          <select id="profile-select">
            <option value="default">Default</option>
            <option value="pota">POTA</option>
            <option value="sota">SOTA</option>
            <option value="satellite">Satellite</option>
            <option value="vhfuhf">VHF/UHF Local</option>
          </select>
        </label>
      </div>
      <div class="optional-picker">
        <div class="grid-2" style="grid-template-columns: minmax(300px, 1fr) auto; align-items: end;">
          <div>
            <input id="add-opt-input" list="opt-fields-list" placeholder="Search to add a field"/>
            <datalist id="opt-fields-list">
              {% for f in optional_fields %}
                <option value="{{ f.label }}"></option>
              {% endfor %}
              {% for tag in adif_suggestions %}
                <option value="{{ tag }}"></option>
              {% endfor %}
            </datalist>
          </div>
          <div class="inline-actions">
            <button type="button" class="btn btn-ghost" id="add-opt-btn">Add</button>
          </div>
        </div>
        <div class="hint">Pick a model field to reveal it, or type an ADIF tag to create a new field. Duplicates are ignored. Empty fields are not saved.</div>
      </div>
      <div class="optional-fields">
        <div id="optional-grid" class="grid-fluid">
          {% for f in optional_fields %}
            {% with field=form|attr:f.name %}
              {% if field %}
              <div class="field optional-field{% if f.checked %} visible{% endif %}" id="field-{{f.name}}-opt" data-name="{{f.name}}">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:4px;">
                  <label style="margin:0;">{{ field.label_tag }}</label>
                  <button type="button" class="btn btn-ghost" data-remove-opt="{{f.name}}" title="Remove field">Remove</button>
                </div>
                {{ field }}
                {% if field.help_text %}<small class="hint">{{ field.help_text }}</small>{% endif %}
                {% for error in field.errors %}<div style="color:#a00">{{ error }}</div>{% endfor %}
              </div>
              {% endif %}
            {% endwith %}
          {% endfor %}
          {# Render existing extras as normal fields #}
          {% for item in extras_items %}
            <div class="field optional-field visible" id="extra-{{ item.key|lower }}-opt" data-extra="{{ item.key|upper }}">
              <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:4px;">
                <label style="margin:0;">{{ item.key|upper }}</label>
                <button type="button" class="btn btn-ghost" data-remove-extra>Remove</button>
              </div>
              <input type="hidden" name="extra_key" value="{{ item.key|upper }}" />
              <input name="extra_val" value="{{ item.val }}" />
            </div>
          {% endfor %}
        </div>
      </div>
    </div>

    

    <div class="actions" style="display:flex; gap:8px; justify-content:flex-end; margin-top: 16px;">
      <a class="btn btn-ghost" href="{% url 'logbook:list' %}">Cancel</a>
      <button class="btn" type="submit">Save Entry</button>
    </div>
  </form>

  <script>
    // Catalog of optional fields from server
    const OPTIONAL_CATALOG = [
      {% for f in optional_fields %}{ name: "{{ f.name }}", label: "{{ f.label }}" }{% if not forloop.last %},{% endif %}{% endfor %}
    ];

    // Lightweight, UI-only operation profiles
    const PROFILES = {
      default: [],
      pota: ["sig", "sig_info", "my_sig", "my_sig_info"],
      sota: ["sota_ref", "my_sota_ref", "sig", "sig_info", "my_sig", "my_sig_info"],
      satellite: ["prop_mode", "sat_name", "band_rx", "freq_rx", "submode"],
      vhfuhf: ["gridsquare", "my_gridsquare", "my_vucc_grids", "tx_pwr"],
    };

    function showOptionalFieldByName(name) {
      const block = document.getElementById('field-' + name + '-opt');
      if (!block) return false;
      block.classList.add('visible');
      const input = block.querySelector('input, select, textarea');
      if (input) input.focus();
      return true;
    }

    function clearAndHideOptionalField(name) {
      const block = document.getElementById('field-' + name + '-opt');
      if (!block) return;
      block.querySelectorAll('input, select, textarea').forEach(el => {
        if (el.tagName === 'SELECT') {
          el.selectedIndex = 0;
        } else {
          el.value = '';
        }
      });
      block.classList.remove('visible');
    }

    function hideOptionalField(name) {
      const block = document.getElementById('field-' + name + '-opt');
      if (!block) return;
      block.classList.remove('visible');
    }

    function fieldHasValue(name) {
      const block = document.getElementById('field-' + name + '-opt');
      if (!block) return false;
      const input = block.querySelector('input, select, textarea');
      if (!input) return false;
      if (input.tagName === 'SELECT') return input.value !== '' && input.selectedIndex > 0;
      return (input.value || '').trim() !== '';
    }

    function applyProfile(key) {
      const wanted = new Set(PROFILES[key] || []);
      OPTIONAL_CATALOG.forEach(it => {
        const { name } = it;
        if (wanted.has(name)) {
          showOptionalFieldByName(name);
        } else {
          // Hide only if no current value to avoid surprising the user
          if (!fieldHasValue(name)) hideOptionalField(name);
        }
      });
      try { localStorage.setItem('loghub.profile', key); } catch (e) {}
    }

    document.getElementById('add-opt-btn').addEventListener('click', () => {
      const inp = document.getElementById('add-opt-input');
      const raw = (inp.value || '').trim();
      if (!raw) return;
      const q = raw.toLowerCase();
      // Try to match a known model field by label or name
      const found = OPTIONAL_CATALOG.find(it => it.label.toLowerCase() === q) || OPTIONAL_CATALOG.find(it => it.name.toLowerCase() === q) || OPTIONAL_CATALOG.find(it => it.label.toLowerCase().includes(q));
      if (found) {
        const block = document.getElementById('field-' + found.name + '-opt');
        if (block && !block.classList.contains('visible')) {
          showOptionalFieldByName(found.name);
        }
        inp.value = '';
        return;
      }
      // Treat as ADIF extra key; create a normal-looking field block if not present
      const key = raw.toUpperCase();
      if (document.querySelector('[data-extra="' + key + '"]')) {
        inp.value = '';
        return;
      }
      const grid = document.getElementById('optional-grid');
      const wrap = document.createElement('div');
      wrap.className = 'field optional-field visible';
      wrap.id = 'extra-' + key.toLowerCase() + '-opt';
      wrap.setAttribute('data-extra', key);
      wrap.innerHTML = `
        <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:4px;">
          <label style="margin:0;">${key}</label>
          <button type="button" class="btn btn-ghost" data-remove-extra>Remove</button>
        </div>
        <input type="hidden" name="extra_key" value="${key}" />
        <input name="extra_val" value="" />
      `;
      grid.appendChild(wrap);
      inp.value = '';
    });

    // Remove buttons for optional fields
    document.addEventListener('click', (e) => {
      const t = e.target;
      if (t && t.matches('button[data-remove-opt]')) {
        const name = t.getAttribute('data-remove-opt');
        clearAndHideOptionalField(name);
      }
      if (t && t.matches('button[data-remove-extra]')) {
        const row = t.closest('[data-extra]');
        if (row) row.remove();
      }
    });

    // Removed separate extras add handler; unified in add-opt-btn

    // Profile init and change handler
    (function initProfile() {
      const sel = document.getElementById('profile-select');
      if (!sel) return;
      try {
        const saved = localStorage.getItem('loghub.profile');
        if (saved && PROFILES[saved]) {
          sel.value = saved;
          applyProfile(saved);
        }
      } catch (e) {}
      sel.addEventListener('change', () => applyProfile(sel.value));
    })();
  </script>
{% endblock %}
